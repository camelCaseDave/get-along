var GetAlong=function(){"use strict";function t(r,a,s,f){return new(s||(s=Promise))(function(t,e){function i(t){try{o(f.next(t))}catch(t){e(t)}}function n(t){try{o(f.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(i,n)}o((f=f.apply(r,a||[])).next())})}function f(i,n){var o,r,a,t,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,r&&(a=2&e[0]?r.return:e[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,e[1])).done)return a;switch(r=0,a&&(e=[2&e[0],a.value]),e[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,r=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=n.call(i,s)}catch(t){e=[6,t],r=0}finally{o=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var n=function(){this.defaultHeight=200,this.defaultWidth=450,this.defaultConfirmButtonLabel="Refresh",this.defaultCancelButtonLabel="Close"},o=(e.prototype.open=function(e,i){var t={height:this.ui.defaultHeight,width:this.ui.defaultWidth},n=this.getConfirmStringsWithDefaults();Xrm.Navigation.openConfirmDialog(n,t).then(function(t){t.confirmed?e():i()})},e.prototype.getCallback=function(t,e){var i=this;return function(){return i.open(function(){Xrm.Navigation.openForm({entityId:e.entityId,entityName:e.entityName})},function(){t.ui.close()})}},e.prototype.getConfirmStringsWithDefaults=function(){return{cancelButtonLabel:this.ui.defaultCancelButtonLabel,confirmButtonLabel:this.ui.defaultConfirmButtonLabel,subtitle:this.confirmStrings.subtitle,text:this.confirmStrings.text,title:this.confirmStrings.title}},e);function e(t,e,i){this.confirmStrings=t,this.ui=new n,this.callback=this.getCallback(e,i)}var r=(i.prototype.setFormNotification=function(){this.formContext.ui.setFormNotification(this.text,"INFO","GetAlongNotification")},i.prototype.getCallback=function(){var t=this;return function(){return t.setFormNotification()}},i);function i(t,e){this.formContext=e,this.text=t,this.callback=this.getCallback()}var a=(s.processModifiedOnDate=function(t){return t&&t.modifiedon?new Date(t.modifiedon).toDateString()+", "+new Date(t.modifiedon).toLocaleTimeString():this.defaultModifiedOnTime},s.processModifiedByUser=function(t){return t&&t.modifiedby&&t.modifiedby.fullname?t.modifiedby.fullname:this.defaultModifiedByUser},s.defaultModifiedByUser="another user",s.defaultModifiedOnTime="the same time",s);function s(){}var u=(c.getLatestModifiedOn=function(e,i,n){return t(this,void 0,Promise,function(){return f(this,function(t){return this.entityId=this.entityId||n||e.data.entity.getId(),this.entityName=this.entityName||i||e.data.entity.getEntityName(),[2,Xrm.WebApi.retrieveRecord(this.entityName,this.entityId,"?$select=modifiedon&$expand=modifiedby($select=fullname)").then(function(t){return t})]})})},c);function c(){}var d=(l.prototype.getModifiedOn=function(){return t(this,void 0,Promise,function(){var e,i,n;return f(this,function(t){switch(t.label){case 0:return(i=this.formContext.getAttribute("modifiedon"))?(e=i.getValue(),[3,3]):[3,1];case 1:return[4,u.getLatestModifiedOn(this.formContext)];case 2:n=t.sent(),e=n.modifiedon,t.label=3;case 3:return[2,this.initialModifiedOn=e]}})})},l.prototype.checkIfModifiedOnHasChanged=function(r){return t(this,void 0,Promise,function(){var e,i,n,o;return f(this,function(t){switch(t.label){case 0:return(i=(e=this).initialModifiedOn)?[3,2]:[4,this.getModifiedOn()];case 1:i=t.sent(),t.label=2;case 2:return e.initialModifiedOn=i,[4,u.getLatestModifiedOn(this.formContext)];case 3:return n=t.sent(),this.latestModifiedBy=a.processModifiedByUser(n),this.latestModifiedOn=a.processModifiedOnDate(n),(o=!!(n.modifiedon&&new Date(n.modifiedon)>new Date(this.initialModifiedOn)))&&r(),[2,o]}})})},l.prototype.addResetOnSave=function(){var t=this;this.formContext.data.entity.addOnSave(function(){t.initialModifiedOn=void 0})},l);function l(t){this.formContext=t,this.addResetOnSave()}var h=function(t){this.entityId=t.data.entity.getId(),this.entityName=t.data.entity.getEntityName()},m=(y.prototype.reload=function(){var t=this.formContext.data.entity.getId(),e=this.formContext.data.entity.getEntityName();Xrm.Navigation.openForm({entityId:t,entityName:e})},y.prototype.preventSave=function(){this.formContext.data.entity.attributes.forEach(function(t){t.setSubmitMode("never")})},y.prototype.isValid=function(){var t=this.formContext.ui.getFormType();return void 0!==t&&0!==t&&1!==t},y.prototype.setDialog=function(t,e){var i=this;!0===t&&void 0!==e?(this.dialog=new o(e,this.formContext,this.metadata),this.notifyUserCallback=function(){i.preventSave(),i.dialog.callback()}):console.error("Get Along has been configured incorrectly. Show dialog has been selected but no confirm strings have been passed.")},y.prototype.setNotification=function(t){var e=this;if(void 0===t||!1===t){var i="This form has been modified by "+this.data.latestModifiedBy+" at "+this.data.latestModifiedOn+". Refresh the form to see latest changes.";this.notification=new r(i,this.formContext),this.notifyUserCallback=function(){e.preventSave(),e.notification.callback()}}},y);function y(t,e,i){this.formContext=t.getFormContext(),this.data=new d(this.formContext),this.metadata=new h(this.formContext),this.setDialog(e,i),this.setNotification(e)}var p=(g.poll=function(a,e,s){return t(this,void 0,Promise,function(){var n,o,r=this;return f(this,function(t){return n=Number(new Date)+1e3*e,o=function(e,i){a().then(function(t){!0===t?e(t):Number(new Date)<n?setTimeout(o.bind(r),1e3*s,e,i):i(console.log("GetAlong has been polling for 30 minutes and will stop now."))})},[2,new Promise(o)]})})},g);function g(){}function b(){}return b.load=function(i,n){return t(this,void 0,Promise,function(){var e;return f(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),this.config=n,this.executionContext=i,this.form=new m(this.executionContext,n.confirmDialog,n.confirmStrings),this.form.isValid()?[4,this.form.data.getModifiedOn()]:[2];case 1:return t.sent(),[4,this.pollForModifications(this.form.notifyUserCallback)];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),console.error("getalong.js has encountered an error. "+e),[3,4];case 4:return[2]}})})},b.pollForModifications=function(i){return t(this,void 0,Promise,function(){var e=this;return f(this,function(t){return p.poll(function(){return e.form.data.checkIfModifiedOnHasChanged(i)},1800/this.config.timeout,this.config.timeout),[2]})})},b}();
