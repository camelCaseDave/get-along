var GetAlong=function(){"use strict";function t(r,a,s,f){return new(s||(s=Promise))(function(t,e){function n(t){try{o(f.next(t))}catch(t){e(t)}}function i(t){try{o(f.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(n,i)}o((f=f.apply(r,a||[])).next())})}function f(n,i){var o,r,a,t,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,r&&(a=2&e[0]?r.return:e[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,e[1])).done)return a;switch(r=0,a&&(e=[2&e[0],a.value]),e[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,r=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=i.call(n,s)}catch(t){e=[6,t],r=0}finally{o=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var r=(e.poll=function(a,e,s){return t(this,void 0,Promise,function(){var i,o,r=this;return f(this,function(t){return i=Number(new Date)+1e3*e,o=function(e,n){a().then(function(t){!0===t?e(t):Number(new Date)<i?setTimeout(o.bind(r),1e3*s,e,n):n(console.log("GetAlong has been polling for 30 minutes and will stop now."))})},[2,new Promise(o)]})})},e);function e(){}var a=(n.processModifiedOnDate=function(t){return t&&t.modifiedon?new Date(t.modifiedon).toDateString()+", "+new Date(t.modifiedon).toLocaleTimeString():this.defaultModifiedOnTime},n.processModifiedByUser=function(t){return t&&t.modifiedby&&t.modifiedby.fullname?t.modifiedby.fullname:this.defaultModifiedByUser},n.defaultModifiedByUser="another user",n.defaultModifiedOnTime="the same time",n);function n(){}var s=(i.getLatestModifiedOn=function(e,n,i){return t(this,void 0,Promise,function(){return f(this,function(t){return this.entityId=this.entityId||i||e.data.entity.getId(),this.entityName=this.entityName||n||e.data.entity.getEntityName(),[2,Xrm.WebApi.retrieveRecord(this.entityName,this.entityId,"?$select=modifiedon&$expand=modifiedby($select=fullname)").then(function(t){return t})]})})},i);function i(){}var o=(u.prototype.getModifiedOn=function(){return t(this,void 0,Promise,function(){var e,n,i;return f(this,function(t){switch(t.label){case 0:return(n=this.formContext.getAttribute("modifiedon"))?(e=n.getValue(),[3,3]):[3,1];case 1:return[4,s.getLatestModifiedOn(this.formContext)];case 2:i=t.sent(),e=i.modifiedon,t.label=3;case 3:return[2,this.initialModifiedOn=e]}})})},u.prototype.checkIfModifiedOnHasChanged=function(r){return t(this,void 0,Promise,function(){var e,n,i,o;return f(this,function(t){switch(t.label){case 0:return(n=(e=this).initialModifiedOn)?[3,2]:[4,this.getModifiedOn()];case 1:n=t.sent(),t.label=2;case 2:return e.initialModifiedOn=n,[4,s.getLatestModifiedOn(this.formContext)];case 3:return i=t.sent(),this.latestModifiedBy=a.processModifiedByUser(i),this.latestModifiedOn=a.processModifiedOnDate(i),(o=!!(i.modifiedon&&new Date(i.modifiedon)>new Date(this.initialModifiedOn)))&&r&&r(),[2,o]}})})},u.prototype.addResetOnSave=function(){var t=this;this.formContext.data.entity.addOnSave(function(){t.initialModifiedOn=void 0})},u);function u(t){this.formContext=t,this.addResetOnSave()}var d=(c.prototype.preventSave=function(t){t.data.entity.attributes.forEach(function(t){t.setSubmitMode("never")})},c);function c(t){this.entityId=t.data.entity.getId(),this.entityName=t.data.entity.getEntityName()}var h=(l.prototype.reload=function(){var t=this.formContext.data.entity.getId(),e=this.formContext.data.entity.getEntityName();Xrm.Navigation.openForm({entityId:t,entityName:e})},l.prototype.isValid=function(){var t=this.formContext.ui.getFormType();return void 0!==t&&0!==t&&1!==t},l);function l(t){this.formContext=t.getFormContext(),this.data=new o(this.formContext),this.metadata=new d(this.formContext)}var m=(y.prototype.getConfirmStringsWithDefaults=function(){return{cancelButtonLabel:this.defaultCancelButtonLabel,confirmButtonLabel:this.defaultConfirmButtonLabel,subtitle:this.confirmStrings.subtitle,text:this.confirmStrings.text,title:this.confirmStrings.title}},y);function y(t){this.defaultHeight=200,this.defaultWidth=450,this.defaultConfirmButtonLabel="Refresh",this.defaultCancelButtonLabel="Close",this.confirmStrings=t}var p=(g.prototype.open=function(){var t=this;return function(){return t.openCallback(function(){t.metadata.preventSave(t.formContext),Xrm.Navigation.openForm({entityId:t.metadata.entityId,entityName:t.metadata.entityName})},function(){t.metadata.preventSave(t.formContext),t.formContext.ui.close()})}},g.prototype.openCallback=function(e,n){var t={height:this.ui.defaultHeight,width:this.ui.defaultWidth},i=this.ui.getConfirmStringsWithDefaults();Xrm.Navigation.openConfirmDialog(i,t).then(function(t){t.confirmed?e():n()})},g);function g(t,e,n){this.formContext=e,this.metadata=n,this.ui=new m(t)}var v=(b.prototype.open=function(){var t=this;return function(){return t.formContext.ui.setFormNotification(t.text,"INFO","GetAlongNotification")}},b);function b(t,e){this.formContext=e,this.text=t}function C(){}return C.pollForConflicts=function(i,o){return t(this,void 0,Promise,function(){var e,n=this;return f(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),this.handleConfig(o),this.form=new h(i),this.form.isValid()?[4,this.form.data.getModifiedOn()]:[2];case 1:return t.sent(),[4,r.poll(function(){return n.form.data.checkIfModifiedOnHasChanged(n.userNotification.open)},1800/o.timeout,o.timeout)];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),console.error("getalong.js has encountered an error. "+e),[3,4];case 4:return[2]}})})},C.checkForConflicts=function(){return t(this,void 0,Promise,function(){return f(this,function(t){try{this.form.data.checkIfModifiedOnHasChanged(this.userNotification.open)}catch(t){console.error("getalong.js has encountered an error. "+t)}return[2]})})},C.handleConfig=function(t){void 0===t.confirmDialog||!1===t.confirmDialog?this.userNotification=this.handleNotification():!0===t.confirmDialog&&void 0!==t.confirmStrings?this.userNotification=this.handleDialog(t):console.error("Get Along has been configured incorrectly. Show dialog has been selected but no confirm strings have been passed.")},C.handleNotification=function(){var t="This form has been modified by "+this.form.data.latestModifiedBy+" at "+this.form.data.latestModifiedOn+". Refresh the form to see latest changes.";return new v(t,this.form.formContext)},C.handleDialog=function(t){return new p(t.confirmStrings,this.form.formContext,this.form.metadata)},C}();
