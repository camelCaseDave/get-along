var GetAlong=function(){"use strict";function t(r,s,a,f){return new(a||(a=Promise))(function(t,i){function e(t){try{o(f.next(t))}catch(t){i(t)}}function n(t){try{o(f.throw(t))}catch(t){i(t)}}function o(i){i.done?t(i.value):new a(function(t){t(i.value)}).then(e,n)}o((f=f.apply(r,s||[])).next())})}function f(e,n){var o,r,s,t,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function i(i){return function(t){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=n.call(e,a)}catch(t){i=[6,t],r=0}finally{o=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,t])}}}var n=(i.prototype.getConfirmStringsWithDefaults=function(){return{cancelButtonLabel:this.defaultCancelButtonLabel,confirmButtonLabel:this.defaultConfirmButtonLabel,subtitle:this.confirmStrings.subtitle,text:this.confirmStrings.text,title:this.confirmStrings.title}},i);function i(t){this.defaultHeight=200,this.defaultWidth=450,this.defaultConfirmButtonLabel="Refresh",this.defaultCancelButtonLabel="Close",this.confirmStrings=t}var e=(o.prototype.open=function(){var t=this;this.isOpen||(this.isOpen=!0,this.openCallback(function(){t.metadata.preventSave(t.formContext),Xrm.Navigation.openForm({entityId:t.metadata.entityId,entityName:t.metadata.entityName})},function(){t.metadata.preventSave(t.formContext),t.formContext.ui.close()}))},o.prototype.openCallback=function(i,e){var t={height:this.ui.defaultHeight,width:this.ui.defaultWidth},n=this.ui.getConfirmStringsWithDefaults();Xrm.Navigation.openConfirmDialog(n,t).then(function(t){t.confirmed?i():e()})},o);function o(t,i,e){this.isOpen=!1,this.formContext=i,this.metadata=e,this.ui=new n(t)}var r=(s.prototype.open=function(){this.isOpen||(this.isOpen=!0,this.formContext.ui.setFormNotification(this.text,"INFO","GetAlongNotification"))},s);function s(t,i){this.isOpen=!1,this.formContext=i,this.text=t}var a="getalong.js",c=a+" config is invalid.",u={configIsInvalid:c+" and therefore won't load",configNotSpecified:c+" No config has been specified.",confirmStringsNotSpecified:c+" Use dialog has been selected but no confirm strings have been passed.",formIsInvalid:a+" thinks the form is invalid and therefore won't load",generic:a+" has encountered an error.",pollingTimeout:a+" has been polling for 30 minutes and will stop now.",timeoutNotSpecified:c+" No timeout has been specified.",timeoutOutsideValidRange:c+" Timeout is outside of valid range."},d=(h.prototype.isValid=function(){return this.validationRules.every(function(t){return!0===t()})},h.prototype.configIsDefined=function(){return void 0!==this.config||(console.error(u.configNotSpecified),!1)},h.prototype.dialogSettingsAreValid=function(){return!0!==this.config.confirmDialog||void 0!==this.config.confirmStrings||(console.error(u.confirmStringsNotSpecified),!1)},h.prototype.timeoutIsDefined=function(){return void 0!==this.config.timeout||(console.error(u.timeoutNotSpecified),!1)},h.prototype.timeoutIsValid=function(){return!(this.config.timeout<1||1800<=this.config.timeout)||(console.error(u.timeoutOutsideValidRange),!1)},h);function h(t){this.config=t,this.validationRules=[this.configIsDefined.bind(this),this.dialogSettingsAreValid.bind(this),this.timeoutIsDefined.bind(this),this.timeoutIsValid.bind(this)]}var l=(m.prototype.getUserNotification=function(){return!0===this.config.confirmDialog&&void 0!==this.config.confirmStrings?this.getDialog():this.getNotification()},m.prototype.isValid=function(){return new d(this.config).isValid()},m.prototype.getNotification=function(){var t="This form has been modified by "+this.form.data.latestModifiedBy+" at "+this.form.data.latestModifiedOn+". Refresh the form to see latest changes.";return new r(t,this.form.formContext)},m.prototype.getDialog=function(){return new e(this.config.confirmStrings,this.form.formContext,this.form.metadata)},m);function m(t,i){this.config=t,this.form=i}var p=(g.poll=function(s,i,a){return t(this,void 0,Promise,function(){var n,o,r=this;return f(this,function(t){return n=Number(new Date)+1e3*i,o=function(i,e){s().then(function(t){!0===t?i(t):Number(new Date)<n?setTimeout(o.bind(r),1e3*a,i,e):e(console.log(u.pollingTimeout))})},[2,new Promise(o)]})})},g);function g(){}var y=(v.processModifiedOnDate=function(t){return t&&t.modifiedon?new Date(t.modifiedon).toDateString()+", "+new Date(t.modifiedon).toLocaleTimeString():this.defaultModifiedOnTime},v.processModifiedByUser=function(t){return t&&t.modifiedby&&t.modifiedby.fullname?t.modifiedby.fullname:this.defaultModifiedByUser},v.defaultModifiedByUser="another user",v.defaultModifiedOnTime="the same time",v);function v(){}var b=(N.getLatestModifiedOn=function(i,e,n){return t(this,void 0,Promise,function(){return f(this,function(t){return this.entityId=this.entityId||n||i.data.entity.getId(),this.entityName=this.entityName||e||i.data.entity.getEntityName(),[2,Xrm.WebApi.retrieveRecord(this.entityName,this.entityId,"?$select=modifiedon&$expand=modifiedby($select=fullname)").then(function(t){return t})]})})},N);function N(){}var C=(w.prototype.getModifiedOn=function(){return t(this,void 0,Promise,function(){var i,e,n;return f(this,function(t){switch(t.label){case 0:return(e=this.formContext.getAttribute("modifiedon"))?(i=e.getValue(),[3,3]):[3,1];case 1:return[4,b.getLatestModifiedOn(this.formContext)];case 2:n=t.sent(),i=n.modifiedon,t.label=3;case 3:return[2,this.initialModifiedOn=i]}})})},w.prototype.checkIfModifiedOnHasChanged=function(r){return t(this,void 0,Promise,function(){var i,e,n,o;return f(this,function(t){switch(t.label){case 0:return(e=(i=this).initialModifiedOn)?[3,2]:[4,this.getModifiedOn()];case 1:e=t.sent(),t.label=2;case 2:return i.initialModifiedOn=e,[4,b.getLatestModifiedOn(this.formContext)];case 3:return n=t.sent(),this.cacheApiResponse(n),(o=!!(n.modifiedon&&new Date(n.modifiedon)>new Date(this.initialModifiedOn)))&&r&&r(),[2,o]}})})},w.prototype.addResetOnSave=function(){var t=this;this.formContext.data.entity.addOnSave(function(){t.initialModifiedOn=void 0})},w.prototype.cacheApiResponse=function(t){this.latestModifiedBy=y.processModifiedByUser(t),this.latestModifiedOn=y.processModifiedOnDate(t)},w);function w(t){this.formContext=t,this.addResetOnSave()}var O=(x.prototype.preventSave=function(t){t.data.entity.attributes.forEach(function(t){t.setSubmitMode("never")})},x);function x(t){this.entityId=t.data.entity.getId(),this.entityName=t.data.entity.getEntityName()}var S=(I.prototype.reload=function(){var t=this.formContext.data.entity.getId(),i=this.formContext.data.entity.getEntityName();Xrm.Navigation.openForm({entityId:t,entityName:i})},I.prototype.isValid=function(){var t=this.formContext.ui.getFormType();return void 0!==t&&0!==t&&1!==t},I);function I(t){this.formContext=t.getFormContext(),this.data=new C(this.formContext),this.metadata=new O(this.formContext)}function M(){}return M.pollForConflicts=function(n,o){return t(this,void 0,Promise,function(){var i,e=this;return f(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),this.init(n,o),[4,this.form.data.getModifiedOn()];case 1:return t.sent(),[4,p.poll(function(){return e.form.data.checkIfModifiedOnHasChanged(e.userNotification.open.bind(e.userNotification))},1800/o.timeout,o.timeout)];case 2:return t.sent(),[3,4];case 3:return i=t.sent(),console.error(u.generic+" "+i),[3,4];case 4:return[2]}})})},M.checkForConflicts=function(i,e){return t(this,void 0,Promise,function(){return f(this,function(t){try{this.init(i,e),this.form.data.checkIfModifiedOnHasChanged(this.userNotification.open.bind(this.userNotification))}catch(t){console.error(u.generic+" "+t)}return[2]})})},M.init=function(t,i){this.form=this.form||new S(t),this.config=this.config||new l(i,this.form),this.form.isValid()?this.config.isValid()?this.userNotification=this.userNotification||this.config.getUserNotification():console.log(u.configIsInvalid):console.log(u.formIsInvalid)},M}();
