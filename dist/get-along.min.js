var GetAlong=function(){"use strict";function t(r,s,a,f){return new(a||(a=Promise))(function(t,i){function e(t){try{o(f.next(t))}catch(t){i(t)}}function n(t){try{o(f.throw(t))}catch(t){i(t)}}function o(i){i.done?t(i.value):new a(function(t){t(i.value)}).then(e,n)}o((f=f.apply(r,s||[])).next())})}function f(e,n){var o,r,s,t,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function i(i){return function(t){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){a.label=i[1];break}if(6===i[0]&&a.label<s[1]){a.label=s[1],s=i;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(i);break}s[2]&&a.ops.pop(),a.trys.pop();continue}i=n.call(e,a)}catch(t){i=[6,t],r=0}finally{o=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,t])}}}var n=(i.prototype.getConfirmStringsWithDefaults=function(){return{cancelButtonLabel:this.defaultCancelButtonLabel,confirmButtonLabel:this.defaultConfirmButtonLabel,subtitle:this.confirmStrings.subtitle,text:this.confirmStrings.text,title:this.confirmStrings.title}},i);function i(t){this.defaultHeight=200,this.defaultWidth=450,this.defaultConfirmButtonLabel="Refresh",this.defaultCancelButtonLabel="Close",this.confirmStrings=t}var e=(o.prototype.open=function(){var t=this;this.isOpen||(this.isOpen=!0,this.openCallback(function(){t.metadata.preventSave(t.formContext),window.parent.location.reload(!1)},function(){t.metadata.preventSave(t.formContext),t.formContext.ui.close()}))},o.prototype.openCallback=function(i,e){var t={height:this.ui.defaultHeight,width:this.ui.defaultWidth},n=this.ui.getConfirmStringsWithDefaults();Xrm.Navigation.openConfirmDialog(n,t).then(function(t){t.confirmed?i():e()})},o);function o(t,i,e){this.isOpen=!1,this.formContext=i,this.metadata=e,this.ui=new n(t)}var r=(s.prototype.open=function(){this.isOpen||(this.isOpen=!0,this.formContext.ui.setFormNotification(this.getNotificationText(),"INFO","GetAlongNotification"))},s.prototype.getNotificationText=function(){return"This form has been modified by "+this.data.latestModifiedBy+" at "+this.data.latestModifiedOn+". Refresh the form to see latest changes."},s);function s(t){this.isOpen=!1,this.data=t.data,this.formContext=t.formContext}var a="getalong.js",u=a+" config is invalid.",c={configIsInvalid:u+" and therefore won't load",configNotSpecified:u+" No config has been specified.",confirmStringsNotSpecified:u+" Use dialog has been selected but no confirm strings have been passed.",formIsInvalid:a+" thinks the form is invalid and therefore won't load",generic:a+" has encountered an error.",pollingDisabled:a+" has been disabled and will stop now.",pollingTimeout:a+" has been polling for 30 minutes and will stop now.",timeoutNotSpecified:u+" No timeout has been specified.",timeoutOutsideValidRange:u+" Timeout is outside of valid range."},d=(l.prototype.isValid=function(){return this.validationRules.every(function(t){return!0===t()})},l.prototype.configIsDefined=function(){return void 0!==this.config||(console.error(c.configNotSpecified),!1)},l.prototype.dialogSettingsAreValid=function(){return!0!==this.config.confirmDialog||void 0!==this.config.confirmStrings||(console.error(c.confirmStringsNotSpecified),!1)},l.prototype.timeoutIsDefined=function(){return void 0!==this.config.timeout||(console.error(c.timeoutNotSpecified),!1)},l.prototype.timeoutIsValid=function(){return!(this.config.timeout<1||1800<=this.config.timeout)||(console.error(c.timeoutOutsideValidRange),!1)},l);function l(t){this.config=t,this.validationRules=[this.configIsDefined.bind(this),this.dialogSettingsAreValid.bind(this),this.timeoutIsDefined.bind(this),this.timeoutIsValid.bind(this)]}var h=(m.prototype.getUserNotification=function(){return!0===this.config.confirmDialog&&void 0!==this.config.confirmStrings?this.getDialog():this.getNotification()},m.prototype.isValid=function(){return new d(this.config).isValid()},m.prototype.getNotification=function(){return new r(this.form)},m.prototype.getDialog=function(){return new e(this.config.confirmStrings,this.form.formContext,this.form.metadata)},m.prototype.parseConfig=function(t){return"number"==typeof t?{timeout:t}:t},m);function m(t,i){this.config=this.parseConfig(t),this.form=i}var p=(g.poll=function(s,i,a){return t(this,void 0,Promise,function(){var n,o,r=this;return f(this,function(t){return this.enabled?(n=Number(new Date)+1e3*i,o=function(i,e){s().then(function(t){r.enabled?!0===t?i(t):Number(new Date)<n?setTimeout(o.bind(r),1e3*a,i,e):e(console.log(c.pollingTimeout)):e(console.log(c.pollingDisabled))})},[2,new Promise(o)]):(console.log(c.pollingDisabled),[2])})})},g.enabled=!0,g);function g(){}var y=(v.processModifiedOnDate=function(t){return t&&t.modifiedon?new Date(t.modifiedon).toDateString()+", "+new Date(t.modifiedon).toLocaleTimeString():this.defaultModifiedOnTime},v.processModifiedByUser=function(t){return t&&t.modifiedby&&t.modifiedby.fullname?t.modifiedby.fullname:this.defaultModifiedByUser},v.defaultModifiedByUser="another user",v.defaultModifiedOnTime="the same time",v);function v(){}var b=(w.getLatestModifiedOn=function(i,e,n){return t(this,void 0,Promise,function(){return f(this,function(t){return this.entityId=this.entityId||n||i.data.entity.getId(),this.entityName=this.entityName||e||i.data.entity.getEntityName(),[2,Xrm.WebApi.retrieveRecord(this.entityName,this.entityId,"?$select=modifiedon&$expand=modifiedby($select=fullname)").then(function(t){return t})]})})},w);function w(){}var C=(N.prototype.init=function(){return t(this,void 0,Promise,function(){var i;return f(this,function(t){switch(t.label){case 0:return[4,b.getLatestModifiedOn(this.formContext)];case 1:return i=t.sent(),this.cacheApiResponse(i),this.initialModifiedOn=i.modifiedon,p.enabled=!0,[2]}})})},N.prototype.checkIfModifiedOnHasChanged=function(n){return t(this,void 0,Promise,function(){var i,e;return f(this,function(t){switch(t.label){case 0:return this.initialModifiedOn?[3,2]:[4,this.init()];case 1:return t.sent(),[2,!1];case 2:return[4,b.getLatestModifiedOn(this.formContext)];case 3:return i=t.sent(),(e=!!(i.modifiedon&&new Date(i.modifiedon)>new Date(this.initialModifiedOn)))&&n&&n(),[2,e]}})})},N.prototype.addResetOnSave=function(){var t=this;this.formContext.data.entity.addOnSave(function(){t.initialModifiedOn=void 0})},N.prototype.cacheApiResponse=function(t){this.latestModifiedBy=y.processModifiedByUser(t),this.latestModifiedOn=y.processModifiedOnDate(t)},N);function N(t){this.formContext=t,this.addResetOnSave()}var S=(x.prototype.preventSave=function(t){t.data.entity.attributes.forEach(function(t){t.setSubmitMode("never")})},x);function x(t){this.entityId=t.data.entity.getId(),this.entityName=t.data.entity.getEntityName()}var O=(I.prototype.init=function(){return t(this,void 0,void 0,function(){return f(this,function(t){return this.data.init(),[2]})})},I.prototype.reload=function(){var t=this.formContext.data.entity.getId(),i=this.formContext.data.entity.getEntityName();Xrm.Navigation.openForm({entityId:t,entityName:i})},I.prototype.isValid=function(){var t=this.formContext.ui.getFormType();return void 0!==t&&0!==t&&1!==t},I);function I(t){this.formContext=t.getFormContext(),this.data=new C(this.formContext),this.metadata=new S(this.formContext)}function D(){}return D.checkForConflicts=function(e,n){return t(this,void 0,Promise,function(){var i;return f(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,D.init(e,n)];case 1:return t.sent()?(D.form.data.checkIfModifiedOnHasChanged(D.userNotification.open.bind(D.userNotification)),[3,3]):[2];case 2:return i=t.sent(),console.error(c.generic+" "+i),[3,3];case 3:return[2]}})})},D.pollForConflicts=function(n,o){return t(this,void 0,Promise,function(){var i,e=this;return f(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,D.init(n,o)];case 1:return t.sent()?[4,p.poll(function(){return e.form.data.checkIfModifiedOnHasChanged(D.userNotification.open.bind(D.userNotification))},1800/o.timeout,o.timeout)]:[2];case 2:return t.sent(),[3,4];case 3:return i=t.sent(),console.error(c.generic+" "+i),[3,4];case 4:return[2]}})})},D.disablePoll=function(){p.enabled=!1},D.init=function(i,e){return t(this,void 0,Promise,function(){return f(this,function(t){switch(t.label){case 0:return[4,(D.form=D.form||new O(i)).init()];case 1:return t.sent(),D.form.isValid()?(D.config=D.config||new h(e,D.form)).isValid()?(D.userNotification=D.userNotification||D.config.getUserNotification(),[2,!0]):(console.log(c.configIsInvalid),[2,!1]):(console.log(c.formIsInvalid),[2,!1])}})})},D}();
